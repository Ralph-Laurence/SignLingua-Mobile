// const sampleDataRyan = {
// 	"tutorDetails": {
// 		"hashedId": "87kx8eV4Yq",
// 		"firstname": "Ryan",
// 		"possessiveName": "Ryan's",
// 		"fullname": "Ryan Paul2",
// 		"username": "Ryan28",
// 		"email": "webtest@gmail.com",
// 		"contact": "09876543210",
// 		"address": "Lingayen Pangasinan",
// 		"verified": true,
// 		"work": null,
// 		"bio": "Certified ASL tutor with 7 years of experience",
// 		"about": "My name is Ryan, originally from Ireland but living in Spain for almost ten years now. I live in Alicante with my wife, our two year old son and our dog. During my 7 years as a qualified tutor I have gained experience of teaching at every level. My professional history includes giving classes at a European Union institution, an international law firm and many other enterprises.",
// 		"education": null,
// 		"certs": null,
// 		"skills": [],
// 		"photo": "http://localhost:8000/storage/uploads/profiles/1.jpg",
// 		"hireStatus": 1,
// 		"averageRating": "4.0",
// 		"totalReviews": 2,
// 		"ratingsAndReviews": [
// 			{
// 				"rating": 5,
// 				"review": "Ryan is great. He prepares each lesson careffully, asks questions , asks about my opinion etc. I recommend him very much.",
// 				"reviewDate": "Jan 13, 2025",
// 				"learnerName": "Diether Montes",
// 				"learnerPhoto": "http://localhost:8000/storage/uploads/profiles/1 (1).png",
// 				"learnerReviewName": "Diether's"
// 			},
// 			{
// 				"rating": 3,
// 				"review": "The teaching style could be improved. But I like the way he organizes lessons.",
// 				"reviewDate": "Jan 14, 2025",
// 				"learnerName": "Nika David",
// 				"learnerPhoto": "http://localhost:8000/storage/uploads/profiles/1737732826.png",
// 				"learnerReviewName": "Nika's"
// 			}
// 		],
// 		"totalIndividualRatings": {
// 			"5": 1,
// 			"4": 0,
// 			"3": 1,
// 			"2": 0,
// 			"1": 0
// 		},
// 		"highestIndividualRating": 1,
// 		"disability": 3,
// 		"disabilityDesc": "Difficulty speaking or do not speak at all.",
// 		"disabilityBadge": "badge_mute"
// 	},
// 	"totalLearners": 2,
// 	"starRatings": {
// 		"1": "Not Satisfied",
// 		"2": "Needs Improvement",
// 		"3": "Acceptable",
// 		"4": "Very Good",
// 		"5": "Excellent"
// 	},
// 	"learnerReview": {
// 		"rating": 3,
// 		"review": "The teaching style could be improved. But I like the way he organizes lessons."
// 	}
// };

// const sampleDataTarzan = {
// 	"tutorDetails": {
// 		"hashedId": "mWMoJME4Qj",
// 		"firstname": "Tarzan",
// 		"possessiveName": "Tarzan's",
// 		"fullname": "Tarzan Cruz",
// 		"username": "Tarzan9",
// 		"email": "bluescreen512@gmail.com",
// 		"disability": 0,
// 		"contact": "9876543210",
// 		"address": "Poblacion Lingayen Pangasinan",
// 		"verified": true,
// 		"work": [
// 			{
// 				"from": "2010",
// 				"to": "2013",
// 				"company": "Lingayen Innovative Solutions",
// 				"role": "Encoder"
// 			}
// 		],
// 		"education": [
// 			{
// 				"from": "2021",
// 				"to": "2022",
// 				"institution": "Pangasinan State University",
// 				"degree": "Bachelors Degree in IT"
// 			},
// 			{
// 				"from": "2013",
// 				"to": "2017",
// 				"institution": "Pangasinan State University",
// 				"degree": "Bachelors Degree in ComSci"
// 			}
// 		],
// 		"certs": [
// 			{
// 				"from": "2012",
// 				"certification": "IELTS",
// 				"description": "IELTS Exceed Writing Workshop"
// 			},
// 			{
// 				"from": "2022",
// 				"certification": "CERVER",
// 				"description": "Linux Web Server Cert"
// 			}
// 		],
// 		"bio": "Unlock Fluent English Sign Language with Expert Guidance: Transform Your Language Skills with Personalised Lessons!",
// 		"about": "<p>Welcome! I'm an English Sign Language tutor with over <strong>15 years</strong> of experience supporting students from high schoolers to C-level executives. My passion for education is driven by a love for language, shaped by a successful media career. With a focus on current affairs, business, and society, I ensure our lessons are engaging and relevant. Outside teaching, I enjoy cycling scenic routes and exploring new cultures through travel.</p><p><br /></p><p>With over 15 years of English language teaching experience, I understand that the biggest challenge for non-native speakers is not just mastering grammar or vocabulary but building the confidence to speak naturally in real-life situations. Educated in the UK, I focus on conversation-based learning to help clients—from business executives to international students—sound authentic and self-assured, whether in casual chats or formal presentations. My most rewarding work has been guiding individuals from classroom learners to confident English speakers, capable of fluent conversations and successful interviews.</p><p><br /></p><p>Ready to elevate your English? Let’s turn your first lesson into an engaging experience. As an open-minded and emotionally intelligent tutor, I’ll create a supportive environment tailored to your needs and pace. Together, we’ll explore the richness of the English language. Book your first lesson today, and let’s start this journey <strong><u>together</u></strong>!</p>",
// 		"skills": [
// 			"Creative Thinking",
// 			"Critical Thinking",
// 			"Innovation"
// 		],
// 		"photo": "http://localhost:8000/storage/uploads/profiles/6x.jpg",
// 		"hireStatus": 2,
// 		"averageRating": "0.0",
// 		"totalReviews": 0,
// 		"ratingsAndReviews": [],
// 		"totalIndividualRatings": {
// 			"5": 0,
// 			"4": 0,
// 			"3": 0,
// 			"2": 0,
// 			"1": 0
// 		},
// 		"highestIndividualRating": 0
// 	},
// 	"totalLearners": 3,
// 	"starRatings": {
// 		"1": "Not Satisfied",
// 		"2": "Needs Improvement",
// 		"3": "Acceptable",
// 		"4": "Very Good",
// 		"5": "Excellent"
// 	},
// 	"learnerReview": null
// };

// const sampleData = sampleDataTarzan;

const disabilityBadges = {
    //0: {'class' : 'disability-', 'img' : '../static/images/badge_noimp_s.png'},
    1: {'class' : 'disability-deaf', 'img' : '../static/images/badge_deaf_s.png'},
    2: {'class' : 'disability-mute', 'img' : '../static/images/badge_mute_s.png'},
    3: {'class' : 'disability-both', 'img' : '../static/images/badge_deafmute_s.png'}
}

const docproofTemplate = 
`<div class="documentary-proof-item text-14 mb-2 d-flex align-items-center overflow-hidden">
    <div class="w-30 me-auto overflow-hidden">
        <div class="w-100 fw-600 text-13 text-muted document-year text-truncate">
            #date#
        </div>
    </div>

    <div class="w-70 ms-auto overflow-hidden">
        <div class="w-100 fw-600 text-dark text-truncate">
            #title#
        </div>
        <div class="w-100 me-auto opacity-60 text-truncate">
            #caption#
        </div>
    </div>
</div>`;

const reviewsTemplate = `
<div class="pinned-rating rating-review-content w-100">
    <div class="w-100 d-flex align-items-center gap-3 overflow-hidden mb-2">
        <img src="#photo#">
        <p class="text-dark text-16 mb-0 d-inline me-auto text-truncate">#name#</p>
    </div>
    <div class="comment-content">
        <p class="text-12">
            <span class="stars">#stars#</span>
            <span class="text-14 ms-2">#date#</span>
        </p>
        <p class="text-14">#content#</p>
    </div>
</div>`;

let ratingControl;

$(document).ready(function()
{
    window.history.pushState(null, "", window.location.href);
    window.onpopstate = function () {
        history.pushState(null, "", window.location.href);
    };

    $('#btn-back').on("click", function () {

        if (window.TutorDetailsJsBridge) {
            window.TutorDetailsJsBridge.onGoBack();
        }
    });

    //renderDetails(sampleData);
});

function renderDetails(json)
{
    if (!json)
    {
        return;
    }

    // If the page is fully loaded, it closes the loader automatically during first load
    // Now if we want to do long running action, we can manually show the loader
    // then hide it manually later on
    if (IS_FULLY_LOADED)
        showLoading();

    let data = JSON.parse(json);
    //let data = json;
    
    const { tutorDetails } = data;
    $('#dynamic-tutor-name').text(tutorDetails.fullname);
    $('#dynamic-tutor-username').text(`@${tutorDetails.username}`);
    $('#dynamic-tutor-bio').text(tutorDetails.bio);
    $('#dynamic-tutor-photo').attr('src', tutorDetails.photo);
    $('.dynamic-tutor-review-count').text(`${formatNumber(tutorDetails.totalReviews)} Reviews`);
    $('#dynamic-tutor-rating-count').text(tutorDetails.averageRating);
    $('#dynamic-tutor-contact-no').text(`(+63) ${tutorDetails.contact}`);
    $('#dynamic-tutor-email').text(tutorDetails.email);
    $('#dynamic-tutor-address').text(tutorDetails.address);
    $('#dynamic-tutor-learner-count').text(data.totalLearners);
    $('#dynamic-tutor-average-rating').text(tutorDetails.averageRating);
    $('#dynamic-tutor-experience-with-name').text(`Share your experience with ${tutorDetails.possessiveName} teaching style.`)
    if (tutorDetails.disability > 0)
    {
        let disability = disabilityBadges[tutorDetails.disability];
        let badge = $('#profile-disability-badge-wrapper');

        badge.attr('class', disability.class);
        badge.find('#dynamic-tutor-disability-badge').attr('src', disability.img);
        badge.show();
    }

    switch (tutorDetails.hireStatus)
    {
        // Tutor is hired by learner ...
        case 1:
            $('#btn-leave-tutor').show();

            // We can only make a review when we are connected to the tutor
            $('#review-controls-wrapper').show();
            break;

        // Tutor havent accepted the hire request yet
        case 2:
            $('#btn-cancel-request').show();
            break;

        // Tutor is for hire
        default:
            $('#btn-hire-tutor').show();
            break;
    }

    if (tutorDetails.about)
    {
        $('#dynamic-tutor-about').html(tutorDetails.about);
        $('#dynamic-tutor-about-full').html(tutorDetails.about);
    }

    if (tutorDetails.averageRating > 0)
    {
        $('#dynamic-tutor-firstname-rating').html(`See what learners are saying about ${tutorDetails.possessiveName} teaching style and expertise.`);
        let starRating = Math.trunc(tutorDetails.averageRating);
        let starRatingContainer = $('#dynamic-tutor-average-rating-stars');

        renderStarCount(starRatingContainer, starRating);

        let totalReviews = tutorDetails.totalReviews; // Total number of reviews

        // Loop through ratings from 5 to 1
        for (let i = 5; i >= 1; i--)
        {
            let ratingCount = tutorDetails.totalIndividualRatings[i] || 0; // Get count, default to 0 if undefined
            let percentage = totalReviews > 0 ? (ratingCount / totalReviews) * 100 : 0; // Calculate percentage

            // Update progress bar width dynamically
            $(`#dynamic-tutor-individual-rating-${i}`).css("width", `${percentage}%`);
            $(`#dynamic-tutor-individual-rating-${i}`).attr("aria-valuenow", percentage);
        }

    }

    if (hasValidData(tutorDetails, "education"))
    {
        let targetContainer = $('#collapseEducation .accordion-body');
        targetContainer.html('');

        tutorDetails.education.forEach( e => {
            let template = docproofTemplate;
            
            template = template.replace("#title#", e.institution)
                .replace("#date#", `${e.from}-${e.to}`)
                .replace("#caption#", `${e.degree}`);
              
            targetContainer.append(template);
        });
    }

    if (hasValidData(tutorDetails, "work"))
    {
        let targetContainer = $('#collapseWork .accordion-body');
        targetContainer.html('');

        tutorDetails.work.forEach( e => {
            let template = docproofTemplate;
            
            template = template.replace("#title#", e.company)
                .replace("#date#", `${e.from}-${e.to}`)
                .replace("#caption#", `${e.role}`);
              
            targetContainer.append(template);
        });
    }

    if (hasValidData(tutorDetails, "certs"))
    {
        let targetContainer = $('#collapseCerts .accordion-body');
        targetContainer.html('');

        tutorDetails.certs.forEach( e => {
            let template = docproofTemplate;
            
            template = template.replace("#title#", e.certification)
                .replace("#date#", e.from)
                .replace("#caption#", `${e.description}`);
              
            targetContainer.append(template);
        });
    }

    if (hasValidData(tutorDetails, "skills"))
    {
        let targetContainer = $('#collapseSkills .skills-container');
        targetContainer.html('');

        tutorDetails.skills.forEach( e => {
            targetContainer.append(`<div class="rounded-2rem bg-light border px-3 py-1">${e}</div>`);
        });
    }

    if (hasValidData(tutorDetails, "ratingsAndReviews"))
    {
        const obj = tutorDetails.ratingsAndReviews[0];
        let $pinnedRating = $('.pinned-rating');

        if (obj.learnerPhoto)
            $pinnedRating.find('#dynamic-pinned-review-userpic').attr('src', obj.learnerPhoto);

        $pinnedRating.find('#dynamic-pinned-review-user-fname').text(obj.learnerName);
        $pinnedRating.find('#dynamic-pinned-review-date').text(obj.reviewDate);
        $pinnedRating.find('#dynamic-pinned-review-comment').text(obj.review);

        renderStarCount($pinnedRating.find('.stars'), obj.rating);
        $pinnedRating.show();

        let fullReviewsContainer = $('#dynamic-tutor-reviews-full');
        fullReviewsContainer.html('');

        tutorDetails.ratingsAndReviews.forEach(rev => {
            let template = reviewsTemplate;
            let stars = renderStarCount(null, rev.rating, 'raw');

            template = template.replace('#date#', rev.reviewDate)
                .replace('#name#', rev.learnerName)
                .replace('#photo#', rev.learnerPhoto)
                .replace('#content#', rev.review)
                .replace('#stars#', stars);

            fullReviewsContainer.append(template);
        });
    }

    // Create an editable star rating control
    //const editableRating = new StarRatingControl('#star-rating-control-editable');

    ratingControl = new StarRatingControl('#my-star-rating-control');

    let shouldEdit = false; // -> Must be true when there was a loaded content
    let btnCancelReview = $('#btn-cancel-review');
    let myReviewInput = $('#my-review-comment');
    let btnEditReview = $('#btn-edit-review');
    let btnPostReview = $('#btn-post-review');
    let btnDeleteReview = $('#btn-delete-review');

    // Adjust this value to be high enough so that the field is visible above the keyboard.
    var extraMargin = 300;

    myReviewInput.on('focus', function() {
        
        // Animate additional bottom margin for visibility.
        $(this).closest('#review-controls-wrapper').animate({ paddingBottom: extraMargin + 'px' }, 300, function()
        {
            $('html, body').animate({ scrollTop: $(document).height() }, 300);
        });
    })
    .on('blur', function() {
        // On blur, reset the bottom margin.
        $(this).closest('#review-controls-wrapper').animate({ paddingBottom: '0px' }, 300);
    });

    btnCancelReview.on('click', () => {
        ratingControl.reset();
        myReviewInput.val(myReviewInput.data('default'));
        
        if (shouldEdit)
        {
            btnEditReview.show();
            btnPostReview.attr('disabled', true);
            btnCancelReview.attr('disabled', true);
            myReviewInput.attr('disabled', true);
            ratingControl.lock();
        }
    });

    btnEditReview.on('click', function() {
        $(this).hide();
        btnCancelReview.attr('disabled', false);
        myReviewInput.attr('disabled', false);
        ratingControl.unlock();
        btnPostReview.attr('disabled', false);
    });

    // Create a read-only star rating control if the user has a review
    if (data.learnerReview)
    {
        shouldEdit = true;
        ratingControl.setInitial(data.learnerReview.rating);
        ratingControl.drawRating(data.learnerReview.rating); // Set rating programmatically
        ratingControl.lock();

        $('.dynamic-review-control-title, #writeReviewBottomSheetLabel').text('Your Review');
        btnEditReview.show();
        myReviewInput
            .val(data.learnerReview.review)
            .data('default', data.learnerReview.review)
            .attr('disabled', true);

        btnCancelReview.attr('disabled', true);
        btnPostReview.attr('disabled', true);
        btnDeleteReview.show();
        //editableRating.drawRating(data.learnerReview.rating);
    }

    // If page is fully loaded, it closes the loader automatically during first load
    // Now if we want to do long running action, we can manually show the loader
    // then hide it manually
    if (IS_FULLY_LOADED)
        hideLoading();
}

function formatNumber(num)
{
    if (num < 1000) return num; // Show full number for values below 1000

    const suffixes = ["", "K", "M", "B", "T"]; // Thousand, Million, Billion, Trillion
    let suffixIndex = Math.floor(Math.log10(num) / 3); // Determine suffix index
    let shortNum = (num / Math.pow(1000, suffixIndex)).toFixed(1); // Format number
    return shortNum.replace(/\.0$/, '') + suffixes[suffixIndex]; // Remove trailing .0
}

function renderStarCount(starRatingContainer = null, starRating, action = 'render')
{
    let temp = "";

    for (var i = 1; i <= 5; i++)
    {
        if (i <= starRating)
            temp += `<i class="fas fa-star text-color-primary-700"></i>`;
        else
            temp += `<i class="fas fa-star opacity-25"></i>`;
    }

    if (action === 'render' && starRatingContainer !== null)
        starRatingContainer.html('').append(temp);

    else if (action === 'raw')
        return temp;
}

function hasValidData(obj, key) {
    return obj[key] && Array.isArray(obj[key]) && obj[key].length > 0;
}